name: "Continuous Integration"

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  build:
    runs-on: [self-hosted, Linux]
    timeout-minutes: 720

    strategy:
      matrix:
        machine: [qemux86-64]

    steps:
      - name: Checkout required repositories
        shell: bash
        run: |
          echo Cloning OE Core
          git clone git://git.openembedded.org/openembedded-core oe-core
          cd oe-core
          git clone git://git.openembedded.org/bitbake bitbake
          git checkout hardknott
          cd bitbake
          git checkout 1.50
          echo

      - name: Checkout this repository
        uses: actions/checkout@v2
        with:
          path: meta-econ

      - name: Setup E-Con Linux environment
        shell: bash
        run: |
          source oe-core/oe-init-build-env build
          cat <<EOF >> conf/local.conf
          BB_NUMBER_THREADS = "4"
          PARALLEL_MAKE = "-j 4"
          do_fetch[number_threads] = "4"
          SSTATE_DIR = "~/openembedded/sstate-cache"
          DL_DIR = "~/openembedded/downloads"
          MACHINE = "${{ matrix.machine }}"
          INHERIT += "rm_work"
          EOF
          sed -i "s/buildstats//g" conf/local.conf
          bitbake-layers add-layer /home/mofm/actions-runner/_work/meta-econ/meta-econ/meta-econ

      - name: Checking parsing of metadata
        shell: bash
        run: |
          source oe-core/oe-init-build-env build
          DISTRO="econ-tiny" bitbake econ-core-image
          DISTRO="econ" bitbake econ-core-image

